# История проекта

## Sprint 1
- Репозиторий клонирован с GitHub и открыт в VS Code.
- Создана папка `docs/`.
- Добавлена документация по рабочему процессу проекта:
  - `SPEC.md`
  - `SPRINT.md`

## Sprint 2

### Основной функционал
- В конфиги добавлены `sectionsOrder` и `sectionsOrderByLang`
  как единый источник истины для порядка секций (с учетом языка).
- Реализована устойчивая логика разрешения секций со строгой цепочкой fallback:
  1) `sectionsOrderByLang[lang]`
  2) `sectionsOrder`
  3) секции, полученные из данных (только если конфиг не дал совпадений)
- Нормализованы ключи секций для обеспечения консистентности
  между языками и CSV-данными.

### Навигация и UX
- Добавлена поддержка deep-links через URL:
  - `?section=` для фильтрации по секциям
  - `?w=` для открытия модального окна вина
- Состояние открытия / закрытия модального окна полностью синхронизировано с URL.
- Добавлен debounced-поиск для снижения лишних перерендеров.
- Реализован in-memory cache для CSV и конфигов
  (без повторных запросов при смене секции).

### Маппинг данных и устойчивость
- Исправлена проблема с рендерингом изображений:
  - CSV-колонка `bottle_img` корректно маппится во внутреннее поле `imageUrl`.
- Добавлена нормализация булевых CSV-полей:
  - `visible`
  - `is_available`
- Реализован защитный CSV-маппинг:
  - валидация обязательных полей
  - защита от пустого UI из-за несовпадения названий колонок

### QA и проверки стабильности
- Добавлены runtime-проверки в консоль:
  - проверка, что вина загружены после маппинга и фильтров
  - валидация обязательных замаппленных ключей
  - проверка `sectionsEffective` на соответствие данным и конфигам
- Поведение вручную проверено через DevTools для:
  - переключения языков EN / ES
  - конфигов Novikov / PeopleTalk
  - консистентности порядка секций
  - рендеринга изображений

## Sprint 3

### UI/UX улучшения карточки вина
- Уменьшено количество шрифтов с 6 до 3 (Proxima Nova, Helvetica Neue, sans-serif)
- Разделены производитель и название вина на отдельные строки:
  - Производитель отображается серым цветом над названием
  - Оба элемента используют единый размер шрифта 19px (17px на мобильных)
- Добавлен многострочный режим для названия вина:
  - Отображается до 2 строк с ellipsis при переполнении
  - Уменьшен размер шрифта с 21px до 19px
  - Установлен line-height: 1.3 для лучшей читаемости
- Оптимизирован размер изображения бутылки:
  - Увеличен max-height до 165px (было 138px)
  - 145px на планшетах (разрешение 930px)
- Подогнана высота серого фона под размер бутылки:
  - 175px для десктопа (под бутылку 165px)
  - 155px для планшетов (под бутылку 145px)
  - Уменьшен border-radius с 18px до 12px
- Синхронизированы шрифты производителя и названия вина (оба 19px/600 weight)
  - синхронизации состояния с URL

### Результат
- Sprint 2 успешно завершен.
- Рендеринг секций детерминирован и безопасен для разных языков.
- Deep-links надежны и готовы к использованию.
- Маппинг CSV → UI явный и защищен от «тихих» ошибок.
- Проект готов к Sprint 3 без технического долга со Sprint 2.

## 2026-01-28 — Sprint 3 (завершен)

### Продуктовые функции и UX
- Реализован быстрый поиск с учетом языка:
  - единый поисковый haystack (name / producer / region / grape),
  - debounced input (250 мс),
  - поведение очистки / сброса с корректным мобильным UX.
- Добавлено управление availability (86):
  - глобальная настройка `hide86` на уровне ресторана,
  - недоступные вина либо скрываются, либо помечаются как “86” прямо в зоне цены,
  - визуальное затемнение недоступных позиций.

### Языки и навигация
- Реализовано переключение языка без полной перезагрузки страницы:
  - CSV перезагружается только для выбранного языка,
  - пересчитываются секции и активное состояние,
  - URL остается синхронизированным (`?lang=`), включая обработку popstate.
- Завершен MVP deep-links для вин:
  - `?w=<wine_id>` открывает модальное окно при загрузке,
  - открытие / закрытие модалки обновляет состояние URL,
  - секция автоматически подстраивается при открытии вина.

### UI и мобильный опыт
- Унифицированы карточки вин и типографика:
  - компактный дизайн карточки,
  - четкая иерархия (title / sub / цены),
  - tasting notes рендерятся как до 3 визуальных chips из поля notes.
- Улучшен мобильный UX:
  - одноколоночный layout,
  - увеличенные зоны нажатия,
  - улучшенный перенос и отступы для chips и текста.

### Доступность
- Добавлена поддержка клавиатуры и accessibility:
  - Esc закрывает модалку только когда она открыта,
  - focus trap внутри модалки (Tab / Shift+Tab),
  - логичный порядок табуляции для элементов управления,
  - видимый focus outline,
  - корректные aria-labels для интерактивных элементов,
  - вкладки секций используют семантические кнопки + pressed state,
  - статус pill сообщает loading/ready через aria-live.

### Изображения и устойчивость
- Добавлен placeholder для изображений бутылок:
  - UI остается стабильным, если `bottle_img` отсутствует или битый.
- Включена нативная lazy-loading загрузка (`loading="lazy"`)
  для изображений бутылок, чтобы улучшить производительность
  на больших винных картах.

### Результат
- Sprint 3 успешно завершен.
- Wine Gallery теперь — production-ready продукт:
  быстрый, доступный и пригодный для шаринга.
- UX консистентен между ресторанами, языками, десктопом и мобильными устройствами.

## 2026-01-31 — Sprint 4 (завершен)

### Валюта и форматирование цен
- Добавлено поле `currency: "USD"` в оба конфига (`peopletalk.json`, `novikov_bh.json`)
- Функция `money()` переписана с использованием `Intl.NumberFormat`:
  - цены форматируются корректно с символом валюты ($102, $30 / glass и т.д.)
  - валюта берётся из конфига ресторана
  - поддержка разных валют в будущем
- Цены отображаются в карточках вин и в модалке

### Объёмы вин (format_ml)
- Объёмы отображаются только в модалке (не на карточках):
  - Бутылка: 750 ml
  - Бокал: 150 ml / 5 oz (для американского рынка)
- Объёмы показываются мелким текстом под соответствующими ценами

### Availability (86) и конфигурация
- Добавлено поле `hide86` в оба конфига ресторанов (значение по умолчанию: `false`)
- Логика фильтрации и отображения уже была реализована в Sprint 3

### Исправления и улучшения UI
- Убрано отображение отладочной информации из хедера:
  - удалены поля `r: novikov_bh` и `lang: en`
  - удалена строка "Updated from CSV"
- Интерфейс стал более чистым и минималистичным

### Исправления багов
- **Баг с испанским языком:** исправлена проблема, когда при переключении на испанский язык отображались только 2 секции (Champagne и All)
  - Причина: CSV испанской версии содержит английские названия секций, а конфиг содержал испанские
  - Решение: добавлено новое поле `sectionLabelsOverride` в конфиги для переопределения названий секций на конкретном языке
  - Логика в `computeSectionsEffective()` применяет переопределение для правильного отображения испанских названий
- **Баг с модалкой:** исправлена автоматическая смена активной секции при открытии модалки
  - Было: при открытии модалки с вином секция автоматически менялась на секцию этого вина
  - Стало: активная секция остаётся той же, где был пользователь (даже если он был в "All")

### Результат
- Sprint 4 успешно завершен.
- Цены и валюта унифицированы и управляются из конфига.
- Объёмы добавлены для информативности (только в модалке).
- Все баги с языками и модалкой исправлены.
- Проект готов к следующему спринту без технического долга.

## 2026-01-31 — Sprint 5 (завершен)

### Pairing для PeopleTalk
- Добавлено поле `pairing` в CSV-маппинг для обоих ресторанов
- Pairing отображается ТОЛЬКО в модалке для PeopleTalk
- В Novikov Beverly Hills pairing полностью скрыт

### Token Dictionary и вкусовые профили
- Реализован словарь токенов (`TOKEN_DICTIONARY`) с 25+ вкусовыми ощущениями
- Каждый токен имеет английское (en) и испанское (es) названия, а также emoji
- Реализована функция `getTokenDisplay()` для локализации названий токенов

### Notes с эмодзи
- Notes отображаются как визуальные чипы с emoji + локализованным названием
- Реализовано для обоих ресторанов на обоих языках (EN/ES)

### Результат Sprint 5
- Pairing полностью реализован с правильной логикой для каждого ресторана
- Token Dictionary обеспечивает богатый, локализованный пользовательский опыт
- Notes отображаются интуитивно с эмодзи и переводами

## 2026-01-31 — Проверка и верификация спринтов 2-5

### Систематическая проверка
- Проведена полная верификация всех требований спринтов 2-5
- Все 41+ требование соответствуют реальной реализации в коде
- Созданы подробные отчеты о верификации (VERIFICATION_REPORT.md, VERIFICATION_SUMMARY_RU.md)

### Результат проверки: ✅ 100% соответствие
- Deep-links, управление секциями, кэширование, поиск (debounce 250ms)
- Смена языка без перезагрузки, форматирование цен через Intl.NumberFormat
- Pairing и Token Dictionary, доступность и keyboard navigation
- Lazy-loading и placeholder для изображений

### Заключение
- Код production-ready и полностью соответствует спецификации
- Проект готов к Sprint 6

## 2026-02-01 — Sprint 6 (завершен)

### Архитектура для масштабирования на 10+ ресторанов

#### Глобальная система аутентификации
- Реализована единая форма входа для всех ресторанов
- Создан файл `configs/auth.json` с глобальным списком пользователей:
  - Формат: `{ users: [{login, password, role, restaurantId}, ...] }`
  - Две тестовые учетные записи: novikov/wine2026 и peopletalk/taste2026
- Функция `validateGlobalCredentials()` проверяет учетные данные против глобального хранилища
- Функция `validateCredentials()` использует глобальную валидацию

#### Автоматическое определение ресторана по учетным данным
- При входе пользователь вводит только логин и пароль
- Система автоматически определяет `restaurantId` из auth.json
- URL обновляется на `/restaurant_id/menu` после успешного входа
- Система поддерживает deep-links типа `/novikov_bh/wine`

#### Конфиденциальность и безопасность
- На стартовой странице скрыт список ресторанов (display:none на restaurantSelector)
- Пользователь видит только "Wine Gallery" на стартовом экране
- После входа видит название и логотип только своего ресторана
- Структура поддерживает будущие роли (guest, manager, admin)

#### Pretty URLs и routing
- Поддержка красивых URL: `/novikov_bh/wine`, `/peopletalk/wine`
- Функция `readRoute()` парсит pathname с учетом `/winegallery/` префикса (для совместимости с deep-links)
- Функция `getBasePath()` кэширует определенный basePath для использования во всех запросах конфигов
- `writeUrlParams()` обновляет URL с сохранением красивого формата

#### Система конфигурации на ресторан
- Каждый ресторан имеет свой config файл (novikov_bh.json, peopletalk.json)
- Расширенная структура конфига:
  - `branding`: logo, subtitle (видны на стартовом экране)
  - `theme`: CSS переменные для кастомизации внешнего вида
  - `menus`: массив меню с поддержкой нескольких языков и CSV-ссылок
  - `enabledLanguages`: массив поддерживаемых языков
  - `defaultLanguage`: язык по умолчанию
  - `sectionLabelsOverride`: переводы названий секций по языкам (для испанского и других)
  - `currency`: валюта (USD)
  - `hide86`: флаг скрытия недоступных вин

#### Многоменю на ресторан
- Структура конфига поддерживает несколько меню (например, Wine List и Desserts)
- Каждое меню может иметь свои CSV-ссылки по языкам
- Функция `normalizeMenus()` извлекает меню из конфига
- Функция `getMenuByKey()` находит конфиг конкретного меню
- Функция `enterMenu()` загружает выбранное меню и переходит на страницу приложения

#### Трансформация после входа пользователя
После успешного входа система:
1. Загружает конфиг ресторана
2. Применяет тему (CSS переменные)
3. Нормализует меню
4. Показывает экран выбора меню с брендированием ресторана
5. При выборе меню показывает основное приложение с топбаром, содержащим:
   - Логотип ресторана
   - Название ресторана
   - Языковой селектор (из enabledLanguages)
   - Поиск и другие управляющие элементы
   - Кнопка Logout

#### Сохранение состояния аутентификации
- Функция `setAuthState()` сохраняет статус аутентификации в sessionStorage
- Функция `readAuthState()` восстанавливает состояние после перезагрузки
- Функция `clearAuthState()` очищает состояние при logout
- Система поддерживает будущие роли через поле `authRole`

### Исправления UI (топбар при входе через форму)

#### Проблема 1: Логотип ресторана не отображался на топбаре
- **Причина**: Функция `normalizeAssetPath()` не добавляла basePath для относительных путей
- **Решение**: Обновлена `normalizeAssetPath()` для добавления `state.basePath` к относительным путям
- **Результат**: Логотипы (novikov-logo.png, peopletalk-logo.png) загружаются с правильным путем

#### Проблема 2: Название ресторана не отображалось на топбаре
- **Причина**: Топбар заполняется в `boot()` функции, но при входе через форму это не происходит
- **Решение**: Добавлен код в `enterMenu()` для установки `restaurantName.textContent`
- **Результат**: "Novikov Beverly Hills" или "PeopleTalk" отображаются корректно

#### Проблема 3: Языковой селектор не видна на топбаре
- **Причина**: Селектор заполняется в `boot()` один раз при загрузке, но после входа через форму он не переполняется
- **Решение**: Добавлено переполнение `langSelect` с опциями из `config.enabledLanguages` в функцию `enterMenu()`
- **Результат**: Языковой селектор показывает EN и ES (для Novikov) или другие языки

#### Проблема 4: Кнопка Logout не реагирует на клики
- **Причина**: Использовалась простая `onclick` которая не всегда срабатывала
- **Решение**: Переключена на `addEventListener` с `{ capture: true }` для более надежного захвата события
- **Дополнительно**: Добавлено `r: null` в `writeUrlParams()` при logout для очистки ресторана из URL
- **Результат**: Logout работает надежно, пользователь возвращается на форму входа

#### Документирование изменений
- Добавлено логирование с префиксами для отладки:
  - `[normalizeAssetPath]` - разрешение путей ассетов
  - `[Boot]` - инициализация при загрузке
  - `[EnterMenu]` - выбор меню и заполнение UI
  - `[renderStartBranding]` - брендирование стартового экрана
  - `[Logout]` - процесс выхода

### Результат Sprint 6
- Архитектура готова для масштабирования на 10+ ресторанов
- Глобальная аутентификация с определением ресторана по учетным данным
- Конфиденциальность - список ресторанов скрыт от конкурентов
- Все четыре UI-проблемы исправлены
- Система поддерживает будущие роли и расширения
- Проект готов к развертыванию в production для нескольких ресторанов

## 2026-02-09 — Обновления ассетов и UI

### Notes-иконки
- Удалены SVG-иконки из `assets/notes`
- Источник иконок переключен на PNG

### Типографика
- Все текстовые цвета приведены к черному по всему проекту

