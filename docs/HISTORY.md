# История проекта

## Sprint 1
- Репозиторий клонирован с GitHub и открыт в VS Code.
- Создана папка `docs/`.
- Добавлена документация по рабочему процессу проекта:
  - `SPEC.md`
  - `SPRINT.md`

## Sprint 2

### Основной функционал
- В конфиги добавлены `sectionsOrder` и `sectionsOrderByLang`
  как единый источник истины для порядка секций (с учетом языка).
- Реализована устойчивая логика разрешения секций со строгой цепочкой fallback:
  1) `sectionsOrderByLang[lang]`
  2) `sectionsOrder`
  3) секции, полученные из данных (только если конфиг не дал совпадений)
- Нормализованы ключи секций для обеспечения консистентности
  между языками и CSV-данными.

### Навигация и UX
- Добавлена поддержка deep-links через URL:
  - `?section=` для фильтрации по секциям
  - `?w=` для открытия модального окна вина
- Состояние открытия / закрытия модального окна полностью синхронизировано с URL.
- Добавлен debounced-поиск для снижения лишних перерендеров.
- Реализован in-memory cache для CSV и конфигов
  (без повторных запросов при смене секции).

### Маппинг данных и устойчивость
- Исправлена проблема с рендерингом изображений:
  - CSV-колонка `bottle_img` корректно маппится во внутреннее поле `imageUrl`.
- Добавлена нормализация булевых CSV-полей:
  - `visible`
  - `is_available`
- Реализован защитный CSV-маппинг:
  - валидация обязательных полей
  - защита от пустого UI из-за несовпадения названий колонок

### QA и проверки стабильности
- Добавлены runtime-проверки в консоль:
  - проверка, что вина загружены после маппинга и фильтров
  - валидация обязательных замаппленных ключей
  - проверка `sectionsEffective` на соответствие данным и конфигам
- Поведение вручную проверено через DevTools для:
  - переключения языков EN / ES
  - конфигов Novikov / PeopleTalk
  - консистентности порядка секций
  - рендеринга изображений
  - синхронизации состояния с URL

### Результат
- Sprint 2 успешно завершен.
- Рендеринг секций детерминирован и безопасен для разных языков.
- Deep-links надежны и готовы к использованию.
- Маппинг CSV → UI явный и защищен от «тихих» ошибок.
- Проект готов к Sprint 3 без технического долга со Sprint 2.

## 2026-01-28 — Sprint 3 (завершен)

### Продуктовые функции и UX
- Реализован быстрый поиск с учетом языка:
  - единый поисковый haystack (name / producer / region / grape),
  - debounced input (250 мс),
  - поведение очистки / сброса с корректным мобильным UX.
- Добавлено управление availability (86):
  - глобальная настройка `hide86` на уровне ресторана,
  - недоступные вина либо скрываются, либо помечаются как “86” прямо в зоне цены,
  - визуальное затемнение недоступных позиций.

### Языки и навигация
- Реализовано переключение языка без полной перезагрузки страницы:
  - CSV перезагружается только для выбранного языка,
  - пересчитываются секции и активное состояние,
  - URL остается синхронизированным (`?lang=`), включая обработку popstate.
- Завершен MVP deep-links для вин:
  - `?w=<wine_id>` открывает модальное окно при загрузке,
  - открытие / закрытие модалки обновляет состояние URL,
  - секция автоматически подстраивается при открытии вина.

### UI и мобильный опыт
- Унифицированы карточки вин и типографика:
  - компактный дизайн карточки,
  - четкая иерархия (title / sub / цены),
  - tasting notes рендерятся как до 3 визуальных chips из поля notes.
- Улучшен мобильный UX:
  - одноколоночный layout,
  - увеличенные зоны нажатия,
  - улучшенный перенос и отступы для chips и текста.

### Доступность
- Добавлена поддержка клавиатуры и accessibility:
  - Esc закрывает модалку только когда она открыта,
  - focus trap внутри модалки (Tab / Shift+Tab),
  - логичный порядок табуляции для элементов управления,
  - видимый focus outline,
  - корректные aria-labels для интерактивных элементов,
  - вкладки секций используют семантические кнопки + pressed state,
  - статус pill сообщает loading/ready через aria-live.

### Изображения и устойчивость
- Добавлен placeholder для изображений бутылок:
  - UI остается стабильным, если `bottle_img` отсутствует или битый.
- Включена нативная lazy-loading загрузка (`loading="lazy"`)
  для изображений бутылок, чтобы улучшить производительность
  на больших винных картах.

### Результат
- Sprint 3 успешно завершен.
- Wine Gallery теперь — production-ready продукт:
  быстрый, доступный и пригодный для шаринга.
- UX консистентен между ресторанами, языками, десктопом и мобильными устройствами.

## 2026-01-31 — Sprint 4 (завершен)

### Валюта и форматирование цен
- Добавлено поле `currency: "USD"` в оба конфига (`peopletalk.json`, `novikov_bh.json`)
- Функция `money()` переписана с использованием `Intl.NumberFormat`:
  - цены форматируются корректно с символом валюты ($102, $30 / glass и т.д.)
  - валюта берётся из конфига ресторана
  - поддержка разных валют в будущем
- Цены отображаются в карточках вин и в модалке

### Объёмы вин (format_ml)
- Объёмы отображаются только в модалке (не на карточках):
  - Бутылка: 750 ml
  - Бокал: 150 ml / 5 oz (для американского рынка)
- Объёмы показываются мелким текстом под соответствующими ценами

### Availability (86) и конфигурация
- Добавлено поле `hide86` в оба конфига ресторанов (значение по умолчанию: `false`)
- Логика фильтрации и отображения уже была реализована в Sprint 3

### Исправления и улучшения UI
- Убрано отображение отладочной информации из хедера:
  - удалены поля `r: novikov_bh` и `lang: en`
  - удалена строка "Updated from CSV"
- Интерфейс стал более чистым и минималистичным

### Исправления багов
- **Баг с испанским языком:** исправлена проблема, когда при переключении на испанский язык отображались только 2 секции (Champagne и All)
  - Причина: CSV испанской версии содержит английские названия секций, а конфиг содержал испанские
  - Решение: добавлено новое поле `sectionLabelsOverride` в конфиги для переопределения названий секций на конкретном языке
  - Логика в `computeSectionsEffective()` применяет переопределение для правильного отображения испанских названий
- **Баг с модалкой:** исправлена автоматическая смена активной секции при открытии модалки
  - Было: при открытии модалки с вином секция автоматически менялась на секцию этого вина
  - Стало: активная секция остаётся той же, где был пользователь (даже если он был в "All")

### Результат
- Sprint 4 успешно завершен.
- Цены и валюта унифицированы и управляются из конфига.
- Объёмы добавлены для информативности (только в модалке).
- Все баги с языками и модалкой исправлены.
- Проект готов к следующему спринту без технического долга.

## 2026-01-31 — Sprint 5 (завершен)

### Pairing для PeopleTalk
- Добавлено поле `pairing` в CSV-маппинг для обоих ресторанов
- Pairing отображается ТОЛЬКО в модалке для PeopleTalk
- В Novikov Beverly Hills pairing полностью скрыт

### Token Dictionary и вкусовые профили
- Реализован словарь токенов (`TOKEN_DICTIONARY`) с 25+ вкусовыми ощущениями
- Каждый токен имеет английское (en) и испанское (es) названия, а также emoji
- Реализована функция `getTokenDisplay()` для локализации названий токенов

### Notes с эмодзи
- Notes отображаются как визуальные чипы с emoji + локализованным названием
- Реализовано для обоих ресторанов на обоих языках (EN/ES)

### Результат Sprint 5
- Pairing полностью реализован с правильной логикой для каждого ресторана
- Token Dictionary обеспечивает богатый, локализованный пользовательский опыт
- Notes отображаются интуитивно с эмодзи и переводами

## 2026-01-31 — Проверка и верификация спринтов 2-5

### Систематическая проверка
- Проведена полная верификация всех требований спринтов 2-5
- Все 41+ требование соответствуют реальной реализации в коде
- Созданы подробные отчеты о верификации (VERIFICATION_REPORT.md, VERIFICATION_SUMMARY_RU.md)

### Результат проверки: ✅ 100% соответствие
- Deep-links, управление секциями, кэширование, поиск (debounce 250ms)
- Смена языка без перезагрузки, форматирование цен через Intl.NumberFormat
- Pairing и Token Dictionary, доступность и keyboard navigation
- Lazy-loading и placeholder для изображений

### Заключение
- Код production-ready и полностью соответствует спецификации
- Проект готов к Sprint 6

