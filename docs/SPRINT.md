# Sprint 2 — Управление секциями, deep-links, производительность

## Description
Этот спринт направлен на то, чтобы сделать Wine Gallery предсказуемым,
управляемым и удобным для шаринга.

Основные цели:
- детерминированный контроль порядка секций (независимо от порядка строк в CSV);
- URL-based deep-links для секций и отдельных вин, чтобы менеджеры и сомелье могли делиться точными представлениями;
- улучшение производительности и UX за счёт сокращения лишних сетевых запросов и перерисовок UI.

В этом спринте вводится поведение, управляемое конфигурацией,
как единый source of truth,
и закладывается основа для более сложного UX в следующих спринтах.

## Goal
Контроль порядка секций и удобные deep-links
для использования менеджерами и сомелье.

---

## Task 2.1 — Порядок секций, управляемый только данными (config / sections table)

### Description / DoD
- Порядок секций должен быть стабильным и предсказуемым.
- Рендеринг НЕ должен зависеть от порядка строк в CSV.

### Subtask 2.1.1 — Добавить `sectionsOrder` в конфиги (оба ресторана)
**Description / DoD:**
- Добавить поле `sectionsOrder` в:
  - `configs/peopletalk.json`
  - `configs/novikov_bh.json`
- Явно определить желаемый порядок секций в конфиге.
**Status:** ✅ Done

### Subtask 2.1.2 — Использовать `sectionsOrder` как source of truth
**Description / DoD:**
- Если `sectionsOrder` присутствует:
  - рендерить ТОЛЬКО секции, перечисленные в `sectionsOrder`;
  - строго соблюдать порядок из конфига.
- Если `sectionsOrder` отсутствует:
  - fallback на порядок, полученный из данных (временное поведение).
**Status:** ✅ Done

### Subtask 2.1.3 — Языко-зависимый порядок секций (`sectionsOrderByLang`)
**Description / DoD:**
- Поддержать `sectionsOrderByLang[lang]` в конфиге для ресторанов,
  где названия секций различаются по языкам.
- Цепочка fallback:
  1) `sectionsOrderByLang[lang]` (если есть и не пусто)
  2) `sectionsOrder`
  3) секции, полученные из данных (только если конфиг не дал совпадений)
**Status:** ✅ Done

---

## Task 2.2 — Deep-links и поведение URL

### Description / DoD
- URL должен открывать корректный ресторан, язык, секцию и вино.
- URL должен отражать текущее состояние UI.

### Subtask 2.2.1 — Поддержка `?section=<key>`
**Description / DoD:**
- При первичной загрузке:
  - считать `section` из URL и активировать её.
- При клике на секцию:
  - обновлять URL с ключом активной секции.
**Status:** ✅ Done

- Активная секция применяется из URL при загрузке
- URL обновляется при смене секции через UI
- Параметр `section` удаляется при выборе “All”

### Subtask 2.2.2 — Поддержка `?w=<wine_id>` (логика модалки)
**Description / DoD:**
- Если `w` присутствует в URL при загрузке:
  - открыть модалку соответствующего вина.
- При клике на карточку вина:
  - открыть модалку и обновить URL с `w=<wine_id>`.
- При закрытии модалки:
  - удалить `w` из URL.
**Status:** ✅ Done

- Модалка открывается при наличии `?w=<wine_id>` при загрузке
- URL обновляется при открытии модалки
- `w` удаляется из URL при закрытии

---

## Task 2.3 — Улучшения производительности и UX

### Description / DoD
- Сократить лишние сетевые запросы.
- Улучшить субъективную отзывчивость, особенно на мобильных устройствах.

### Subtask 2.3.1 — Кэширование config и CSV на время сессии
**Description / DoD:**
- Кэшировать загруженные config и CSV в памяти.
- НЕ делать повторный fetch при смене секции,
  если ресторан и язык не изменились.
**Status:** ✅ Done

- Config и CSV кэшируются в памяти на время сессии
- Смена секций не вызывает повторный fetch при неизменных r/lang

### Subtask 2.3.2 — Debounce поискового инпута (200–300 мс)
**Description / DoD:**
- Добавить debounce к поисковому инпуту.
- Снизить количество лишних перерисовок,
  сохраняя отзывчивость UI.
**Status:** ✅ Done

- Поиск задебаунсен (250 мс)
- Снижается количество лишних ререндеров, особенно на мобильных

---

## Task 2.4 — Корректность маппинга данных (CSV → UI)

### Description / DoD
- Все UI-поля должны явно маппиться из заголовков CSV.
- Исключить «тихие» баги пустого UI из-за несовпадения имён колонок.

### Subtask 2.4.1 — Исправить маппинг изображения бутылки
**Description / DoD:**
- Замаппить колонку CSV `bottle_img` → внутреннее поле `imageUrl`.
- Изображения бутылок должны отображаться в карточках и модалке.
**Status:** ✅ Done

### Subtask 2.4.2 — Нормализация boolean и предотвращение “нет вин после фильтров”
**Description / DoD:**
- `visible` / `is_available` должны нормализовываться в реальные boolean.
- Поддержка "yes/no", "true/false", "1/0" и non-breaking spaces.
**Status:** ✅ Done

### Subtask 2.4.3 — QA sanity-проверки (console)
**Description / DoD:**
- Проверить в консоли:
  - `state.wines.length > 0`
  - у первого вина есть ключи:
    `id, title, section, sectionKey, imageUrl, priceGlass, priceBottle, visible, available`
  - `state.sectionsEffective` соответствует ожидаемым табам для текущего `lang`
**Status:** ✅ Done

---

# Sprint 3 — Продуктовые функции и UX

## Description
Этот спринт направлен на превращение Wine Gallery
из «красивого меню»
в реальный, продаваемый продукт
с сильным UX и операционными возможностями.

Спринт улучшает:
- качество и скорость поиска;
- управление availability (86);
- переключение языка без перезагрузки страницы;
- deep-links на конкретные вина;
- визуальную консистентность, мобильный UX и доступность.

Функциональность должна работать идентично для обоих ресторанов.

## Goal
Сделать Wine Gallery быстрым, управляемым, удобным для шаринга
и комфортным в использовании
для гостей, менеджеров и сомелье.

---

## Definition of Done (DoD)

Пользователь может:
- быстро найти вино через поиск;
- скрыть или пометить unavailable-вина (86);
- переключить язык без полной перезагрузки страницы;
- открыть вино по прямой ссылке;
- комфортно пользоваться меню на мобильных устройствах;
- навигировать UI с клавиатуры и screen readers.

---

## Task 3.1 — Поиск по ключевым полям вина

### Description / DoD
- Поиск работает без заметных лагов.
- Поиск включает как минимум:
  - название вина,
  - производителя,
  - регион,
  - сорт винограда.
- Поведение идентично для обоих ресторанов.
- Поиск работает только в рамках выбранного языка.

### Subtask 3.1.1 — Построение поискового индекса (haystack)

**Description / DoD:**
- Сформировать одну поисковую строку (haystack) на каждое вино.
- Объединить ключевые поля (name, producer, region, grape).
- Нормализовать значения (без учёта регистра, trim).
- Реализация поиска через `includes()`.

**Implementation order:** Phase 1  
**Status:** ✅ Done

---

### Subtask 3.1.2 — Debounce поиска и очистка

**Description / DoD:**
- Debounce поискового инпута (200–300 мс).
- Реализовать clear / reset поведение.
- Обеспечить корректный UX на мобильных устройствах.

**Implementation order:** Phase 2  
**Status:** ✅ Done

---

## Task 3.2 — Availability (is_available) и режим “86”

### Description / DoD
- Доступность вин контролируется через `is_available`.
- Поведение конфигурируемо:
  - скрывать unavailable-вина,
  - либо показывать их с бейджем “86”.

### Subtask 3.2.1 — Опция `hide86` в конфиге и бейдж

**Description / DoD:**
- Добавить `hide86: true | false` в конфиг ресторана.
- Если `hide86 = true`:
  - вина с `is_available = false` скрываются.
- Если `hide86 = false`:
  - вина остаются видимыми и помечаются бейджем “86”.
- Опция глобальна для ресторана.

**Implementation order:** Phase 3  
**Status:** ✅ Done

---

## Task 3.3 — Переключение языка без полной перезагрузки

### Description / DoD
- Переключение языка не должно вызывать `window.location.reload()`.
- UI обновляется динамически.
- URL синхронизируется с состоянием.

### Subtask 3.3.1 — Синхронизация языка с URL и UI

**Description / DoD:**
- Обновлять `?lang=` в URL при смене языка.
- Перезагружать CSV данные только для выбранного языка.
- Пересчитывать секции и карточки вин.
- Корректно fallback-иться на `defaultLanguage`.

**Implementation order:** Phase 4  
**Status:** ✅ Done

---

## Task 3.4 — Deep-link на конкретное вино

### Description / DoD
- Поддержка URL вида `?r=restaurant&lang=en&w=wine_id`.
- Переход по ссылке открывает нужное вино.

### Subtask 3.4.1 — MVP-решение через модалку

**Description / DoD:**
- Использовать модалку как MVP-решение.
- Если `w` присутствует в URL:
  - открыть модалку при загрузке.
- При открытии модалки:
  - обновлять URL с `w`.
- При закрытии:
  - удалять `w` из URL.

**Implementation order:** Phase 5  
**Status:** ✅ Done

---

## Task 3.5 — Унификация карточек и типографики

### Description / DoD
- Карточки вин следуют единому визуальному стандарту.
- Чёткая иерархия:
  - title,
  - producer,
  - region,
  - prices.
- Консистентные отступы и выравнивание.

### Subtask 3.5.1 — Компактные карточки и заметки-чипы

**Description / DoD:**
- Уменьшить высоту карточек.
- Сделать “story” более компактным.
- Отображать tasting notes (`notes`) в виде до 3 визуальных чипов.

**Implementation order:** Phase 6  
**Status:** ✅ Done

---

### Subtask 3.5.2 — Улучшения мобильного лейаута

**Description / DoD:**
- Одноколоночный layout на мобильных.
- Увеличенные tap-таргеты.
- Комфортный скролл и взаимодействие.

**Implementation order:** Phase 7  
**Status:** ✅ Done

---

## Task 3.6 — Доступность и поддержка клавиатуры

### Description / DoD
- Улучшить доступность для клавиатуры и screen readers.

### Subtask 3.6.1 — Фокус и tab-навигация

**Description / DoD:**
- `Esc` закрывает модалку.
- Корректная работа фокуса.
- Логичный tab-порядок.
- Видимый focus outline.
- Корректные `aria-label`.

**Implementation order:** Phase 8  
**Status:** ✅ Done

### Subtask 3.6.2 — Семантика табов секций (buttons)
**Description / DoD:**
- Таб-секции рендерятся как `<button>`, а не `<div>`.
- Активное состояние использует `aria-pressed="true"`.
**Status:** ✅ Done

### Subtask 3.6.3 — Live-статус для screen readers
**Description / DoD:**
- Статус-индикатор использует `role="status"` и `aria-live="polite`,
  чтобы screen reader озвучивал состояния loading / ready / error.
**Status:** ✅ Done

---

## Task 3.7 — Изображения и плейсхолдеры

### Description / DoD
- Карточки вин не должны ломаться,
  если изображение бутылки отсутствует или не загружается.

### Subtask 3.7.1 — Placeholder-изображение

**Description / DoD:**
- Добавить локальный placeholder:
  - `assets/placeholder-bottle.png` или `.svg`.
- Использовать placeholder, если `bottle_img` отсутствует или невалиден.

**Implementation order:** Phase 9  
**Status:** ✅ Done

---

### Subtask 3.7.2 — Lazy-loading изображений

**Description / DoD:**
- Использовать `loading="lazy"` для изображений бутылок.
- Обеспечить graceful fallback-поведение.

**Implementation order:** Phase 10  
**Status:** ✅ Done

---

# Sprint 4 — Цены, валюта и availability (логика меню)

## Description
Этот спринт фокусируется на унификации логики цен, валюты
и статуса доступности (86),
чтобы поведение меню было корректным, предсказуемым и единообразным.

## Goal
Корректные цены и статус 86,
единые и управляемые правила отображения.

---

## Definition of Done (DoD)

- Все цены форматируются единым способом.
- Валюта задаётся на уровне конфига ресторана.
- Отображение BTG и Bottle следует явным правилам.
- Поведение unavailable-вин (86) управляется через конфиг.

---

## Task 4.1 — Валюта из config/restaurants и форматирование цен

### Description / DoD
- Валюта задаётся на уровне ресторана.
- Форматирование цен выполняется через `Intl.NumberFormat`.

### Subtask 4.1.1 — Добавить `currency` в конфиги

**Description / DoD:**
- Добавить `currency` в `peopletalk.json` и `novikov_bh.json`.
- Начальное значение: `USD`.
**Status:** ✅ Done

- Поле `currency: "USD"` добавлено в оба конфига ресторанов

### Subtask 4.1.2 — Единый формат BTG / Bottle

**Description / DoD:**
- Если `btg_price` отсутствует — `/glass` не показывается.
- Цена бутылки отображается независимо.
**Status:** ✅ Done

- Функция `money()` переписана с использованием `Intl.NumberFormat`
- Валюта берётся из конфига ресторана и форматируется корректно ($102, $30 / glass и т.д.)
- Цены отображаются в карточках вин и в модалке
- Если `btg_price` отсутствует, `/glass` не показывается

---

## Task 4.2 — `format_ml` как UI-дефолт

### Description / DoD
- Используется дефолтный объём (например, 750ml).
- Объём не отображается без UX-решения.

### Subtask 4.2.1 — Решение по отображению объёма

**Description / DoD:**
- Принять решение: показываем ли объём и где (карточка / модалка).
**Status:** ✅ Done

- Объём отображается только в модалке (не на карточках)
- Бутылка: 750 ml
- Бокал: 150 ml / 5 oz (для американского рынка)

---

## Task 4.3 — Availability и логика 86

### Description / DoD
- Поведение unavailable-вин определяется через конфиг.

### Subtask 4.3.1 — Тоггл поведения 86

**Description / DoD:**
- `hide86 = true` — скрывать unavailable-вина.
- `hide86 = false` — показывать с чипом “Out of stock”.**Status:** ✅ Done

- Поле `hide86` добавлено в оба конфига с начальным значением `false`
- Логика фильтрации и отображения "Out of stock" уже была реализована в Sprint 3

---

# Sprint 5 — PeopleTalk pairing + профиль notes (иконки/чипы)

## Description
Этот спринт фокусируется на функциях, которые «продают»:
food pairing и понятные tasting notes,
чтобы карточки и модалка вина
были интуитивными и визуально читаемыми.
Реализация ориентирована на PeopleTalk
и отличается от Novikov на уровне UI и логики.

## Goal
Функции, которые «продают»:
pairing и понятные notes.

---

## Definition of Done (DoD)

- Pairing отображается только для PeopleTalk.
- В Novikov pairing полностью скрыт.
- Notes отображаются как 3 визуальных токена.
- Токены имеют человекочитаемые названия (en/es).
- Используется MVP-реализация иконок.
- Модалка вина поддерживает deep-links.

---

## Task 5.1 — Pairing только для PeopleTalk

### Description / DoD
- Показывать блок pairing в карточке/модалке
  только при `r=peopletalk`.

### Subtask 5.1.1 — UI для pairing (место и стиль)

**Description / DoD:**
- Определить, где показывать pairing:
  карточка или модалка.
- В Novikov pairing скрыт полностью.

**Status:** ✅ Done

- Pairing отображается только в модалке для PeopleTalk
- В Novikov pairing полностью скрыт

---

## Task 5.2 — Notes profile: 3 ощущения (tokens)

### Description / DoD
- Парсить `notes_profile` вида
  `citrus|green_apple|stone_fruit`.
- Рендерить notes как 3 чипа / иконки.

### Subtask 5.2.1 — Словарь токенов → человекочитаемые названия (en/es)

**Description / DoD:**
- Маппинг токенов в человекочитаемые названия.
- Пример:
  `green_apple → Green apple / Manzana verde`.
- Язык зависит от текущего языка UI.

**Status:** ✅ Done

- Реализован словарь токенов TOKEN_DICTIONARY с 25+ токенами и их переводами
- Названия токенов отображаются в зависимости от языка UI (en/es)

---

### Subtask 5.2.2 — Иконки/эмодзи или мини-svg (MVP)

**Description / DoD:**
- MVP:
  эмодзи или простые svg из assets.
- Реализация допускает дальнейшее улучшение.

**Status:** ✅ Done

- Используются эмоджи для каждого токена (MVP)
- Архитектура позволяет заменить эмоджи на SVG без изменения логики

---

## Task 5.3 — Модалка (детали вина)

### Description / DoD
- Открытие карточки вина с подробной информацией.
- Deep-link интеграция из Sprint 2.

### Subtask 5.3.1 — Содержимое модалки (поля + layout)

**Description / DoD:**
- Producer, name, vintage, region, grape, story, notes, pairing.

**Status:** ✅ Done

- Модалка отображает все ею характеристики
- Pairing отображается только для PeopleTalk

