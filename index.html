<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Wine Gallery</title>

  <style>
    /* =========================================================
       THEME TOKENS (default; overwritten by config.theme)
       ========================================================= */
    :root{
      --bg: #0b0b0b;
      --panel: #111;
      --text: #f5f5f5;
      --muted: rgba(245,245,245,.7);
      --border: rgba(255,255,255,.12);
      --accent: #1f8a4c;   /* Novikov green default */
      --accent2: #0e5f34;
      --chip: rgba(255,255,255,.08);
      --chipText: rgba(245,245,245,.92);
      --shadow: 0 10px 24px rgba(0,0,0,.35);
      --radius: 16px;
      --maxw: 1080px;
      --font: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    }

    /* =========================================================
       BASE
       ========================================================= */
    html, body { height: 100%; }
    body{
      margin:0;
      font-family: var(--font);
      background: radial-gradient(1200px 700px at 20% 10%, rgba(31,138,76,.18), transparent 55%),
                  radial-gradient(900px 600px at 90% 30%, rgba(255,255,255,.06), transparent 55%),
                  var(--bg);
      color: var(--text);
    }

    a{ color: inherit; }
    .wrap{
      max-width: var(--maxw);
      margin: 0 auto;
      padding: 22px 18px 48px;
    }

    /* =========================================================
       HEADER
       ========================================================= */
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
      padding: 14px 16px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: rgba(17,17,17,.72);
      backdrop-filter: blur(8px);
      box-shadow: var(--shadow);
    }

    .brand{
      display:flex;
      align-items:center;
      gap:12px;
      min-width: 180px;
    }

    .brand img{
      height: 34px;
      width: auto;
      display:block;
      filter: drop-shadow(0 6px 14px rgba(0,0,0,.35));
    }
    .brand .title{
      display:flex;
      flex-direction:column;
      line-height:1.1;
    }
    .brand .title strong{
      font-size: 14px;
      letter-spacing: .3px;
    }
    .brand .title span{
      font-size: 12px;
      color: var(--muted);
    }

    .controls{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap: wrap;
      justify-content:flex-end;
    }

    .chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 8px 10px;
      background: var(--chip);
      border: 1px solid var(--border);
      border-radius: 999px;
      color: var(--chipText);
      font-size: 12px;
      user-select:none;
    }

    .btn{
      cursor:pointer;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding: 9px 12px;
      border-radius: 999px;
      font-size: 12px;
      transition: transform .05s ease, background .15s ease;
    }
    .btn:hover{ background: rgba(255,255,255,.10); }
    .btn:active{ transform: scale(.98); }

    .btn.primary{
      border-color: rgba(31,138,76,.55);
      background: linear-gradient(180deg, rgba(31,138,76,.28), rgba(31,138,76,.14));
    }

    .select{
      border: 1px solid var(--border);
      background: rgba(0,0,0,.25);
      color: var(--text);
      padding: 9px 12px;
      border-radius: 999px;
      font-size: 12px;
      outline: none;
    }

    .search{
      border: 1px solid var(--border);
      background: rgba(0,0,0,.25);
      color: var(--text);
      padding: 9px 12px;
      border-radius: 999px;
      font-size: 12px;
      outline: none;
      width: 220px;
    }

    /* =========================================================
       SECTIONS NAV
       ========================================================= */
    .sectionNav{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin: 16px 2px 10px;
      align-items:center;
    }
    .pill{
      cursor:pointer;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.05);
      font-size: 12px;
      color: var(--chipText);
      transition: background .15s ease, transform .05s ease;
    }
    .pill:hover{ background: rgba(255,255,255,.09); }
    .pill.active{
      border-color: rgba(255,255,255,.22);
      background: linear-gradient(180deg, rgba(31,138,76,.32), rgba(31,138,76,.14));
    }

    /* =========================================================
       GRID / CARDS
       ========================================================= */
    .grid{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 14px;
      margin-top: 10px;
    }

    .card{
      grid-column: span 12;
      display:flex;
      gap:14px;
      padding: 14px;
      border-radius: var(--radius);
      background: rgba(17,17,17,.72);
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      backdrop-filter: blur(8px);
    }

    @media (min-width: 860px){
      .card{ grid-column: span 6; }
    }

    .bottle{
      width: 92px;
      min-width: 92px;
      height: 160px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.05);
      overflow:hidden;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .bottle img{
      width: 100%;
      height: 100%;
      object-fit: cover;
      display:block;
    }

    .meta{
      display:flex;
      flex-direction:column;
      gap:8px;
      width: 100%;
    }

    .line1{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }

    .nameBlock strong{
      display:block;
      font-size: 14px;
      letter-spacing: .2px;
    }
    .nameBlock span{
      display:block;
      font-size: 12px;
      color: var(--muted);
      margin-top: 2px;
      line-height: 1.25;
    }

    .prices{
      text-align:right;
      min-width: 74px;
      font-size: 12px;
      line-height: 1.2;
      color: var(--chipText);
    }
    .prices .big{
      font-size: 14px;
      font-weight: 700;
      color: var(--text);
    }

    .tags{
      display:flex;
      gap:8px;
      flex-wrap: wrap;
    }
    .tag{
      font-size: 11px;
      padding: 6px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.05);
      color: var(--chipText);
    }

    .desc{
      font-size: 12px;
      color: var(--muted);
      line-height: 1.35;
      white-space: pre-wrap;
    }

    .foot{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-top: 2px;
    }
    .muted{ color: var(--muted); font-size: 12px; }

    /* =========================================================
       STATUS / ERROR
       ========================================================= */
    .status{
      margin: 14px 2px 0;
      padding: 12px 14px;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      background: rgba(255,255,255,.05);
      color: var(--chipText);
      font-size: 12px;
      display:none;
      white-space: pre-wrap;
    }
    .status.show{ display:block; }

  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <img id="logo" alt="logo" />
        <div class="title">
          <strong id="restaurantName">Wine Gallery</strong>
          <span id="subtitle">Loading…</span>
        </div>
      </div>

      <div class="controls">
        <span class="chip" id="chipRestaurant">r: —</span>
        <span class="chip" id="chipLang">lang: —</span>

        <select class="select" id="restaurantSelect" title="Restaurant">
          <option value="novikov_bh">Novikov BH</option>
          <option value="peopletalk">PeopleTalk</option>
        </select>

        <select class="select" id="langSelect" title="Language">
          <option value="en">EN</option>
          <option value="es">ES</option>
        </select>

        <input class="search" id="searchInput" placeholder="Search…" />

        <button class="btn primary" id="btnReload">Reload</button>
      </div>
    </div>

    <div class="sectionNav" id="sectionNav"></div>

    <div class="status" id="statusBox"></div>

    <div class="grid" id="grid"></div>
  </div>

  <script>
    /************************************************************
     * WineGallery v2 (multi-restaurant + multi-language)
     * - Loads configs/{r}.json
     * - Loads CSV from config.csvUrl[lang]
     * - Renders sections and wines
     * - Language switch WITHOUT page reload (re-fetch CSV)
     * - Robust: missing logo/image doesn't white-screen
     ************************************************************/

    // -----------------------------
    // Utilities
    // -----------------------------
    const qs = (sel) => document.querySelector(sel);
    const el = (id) => document.getElementById(id);

    function getParam(name){
      const u = new URL(window.location.href);
      return u.searchParams.get(name);
    }
    function setParam(name, value){
      const u = new URL(window.location.href);
      u.searchParams.set(name, value);
      history.replaceState({}, "", u.toString());
    }

    function baseUrl(){
      // Always resolve relative to the current folder (…/winegallery/)
      return new URL(".", window.location.href);
    }

    function normalizeLogoUrl(url){
      if(!url) return "";
      // If config has "/assets/..." this breaks on project pages -> make it relative.
      if(url.startsWith("/assets/")) return url.replace("/assets/", "assets/");
      if(url.startsWith("/configs/")) return url.replace("/configs/", "configs/");
      if(url.startsWith("/data/"))    return url.replace("/data/", "data/");
      return url;
    }

    function showStatus(msg){
      const box = el("statusBox");
      box.textContent = msg;
      box.classList.add("show");
    }
    function hideStatus(){
      const box = el("statusBox");
      box.textContent = "";
      box.classList.remove("show");
    }

    function applyTheme(themeName){
      // Theme presets (you can extend later)
      const root = document.documentElement;

      const themes = {
        novikov_clean: {
          "--bg":"#070807",
          "--panel":"#101210",
          "--text":"#F6F7F6",
          "--muted":"rgba(246,247,246,.72)",
          "--border":"rgba(255,255,255,.12)",
          "--accent":"#1f8a4c",
          "--accent2":"#0e5f34",
          "--chip":"rgba(255,255,255,.08)",
          "--chipText":"rgba(246,247,246,.92)"
        },
        peopletalk: {
          "--bg":"#06080d",
          "--panel":"#0f131d",
          "--text":"#F4F7FF",
          "--muted":"rgba(244,247,255,.72)",
          "--border":"rgba(255,255,255,.12)",
          "--accent":"#2b67ff",
          "--accent2":"#1f49b8",
          "--chip":"rgba(255,255,255,.08)",
          "--chipText":"rgba(244,247,255,.92)"
        }
      };

      const t = themes[themeName] || themes.novikov_clean;
      Object.entries(t).forEach(([k,v]) => root.style.setProperty(k,v));
    }

    // Very small CSV parser (handles commas + quotes).
    function parseCSV(text){
      const rows = [];
      let row = [];
      let cur = "";
      let inQuotes = false;

      for (let i = 0; i < text.length; i++){
        const ch = text[i];
        const next = text[i+1];

        if (ch === '"' && inQuotes && next === '"'){ cur += '"'; i++; continue; }
        if (ch === '"'){ inQuotes = !inQuotes; continue; }

        if (!inQuotes && ch === ","){ row.push(cur); cur=""; continue; }
        if (!inQuotes && (ch === "\n" || ch === "\r")){
          if (ch === "\r" && next === "\n") i++;
          row.push(cur); cur="";
          rows.push(row);
          row = [];
          continue;
        }
        cur += ch;
      }
      if (cur.length || row.length){
        row.push(cur);
        rows.push(row);
      }

      const header = (rows.shift() || []).map(h => (h||"").trim());
      return rows
        .filter(r => r.some(x => (x||"").trim() !== ""))
        .map(r => {
          const obj = {};
          header.forEach((h, idx) => obj[h] = (r[idx] ?? "").trim());
          return obj;
        });
    }

    // -----------------------------
    // App state
    // -----------------------------
    const state = {
      r: "novikov_bh",
      lang: "en",
      config: null,
      wines: [],
      filtered: [],
      activeSection: "all",
      sectionsOrdered: []
    };

    // -----------------------------
    // Data loading
    // -----------------------------
    async function loadConfig(restaurantKey){
      const cfgUrl = new URL(`configs/${restaurantKey}.json`, baseUrl()).toString();
      const res = await fetch(cfgUrl, { cache: "no-store" });
      if(!res.ok) throw new Error(`Config not found: ${cfgUrl} (${res.status})`);
      const cfg = await res.json();

      // Normalize logoUrl for GH Pages project-site
      cfg.logoUrl = normalizeLogoUrl(cfg.logoUrl);

      return cfg;
    }

    async function loadCSV(csvUrl){
      const res = await fetch(csvUrl, { cache: "no-store" });
      if(!res.ok) throw new Error(`CSV fetch failed (${res.status})`);
      const txt = await res.text();
      return parseCSV(txt);
    }

    // -----------------------------
    // Rendering
    // -----------------------------
    function computeSectionsFromData(wines){
      // If config has sectionsOrder, use it. Else derive.
      const seen = new Set();
      const list = [];
      for(const w of wines){
        const s = (w.section || "").trim();
        if(!s) continue;
        if(!seen.has(s)){
          seen.add(s);
          list.push(s);
        }
      }
      return list;
    }

    function renderHeader(){
      el("restaurantName").textContent = state.config?.name || "Wine Gallery";
      el("chipRestaurant").textContent = `r: ${state.r}`;
      el("chipLang").textContent = `lang: ${state.lang}`;
      el("subtitle").textContent = "Updated from CSV";

      // Logo (do not crash if missing)
      const logo = el("logo");
      const url = state.config?.logoUrl || "";
      if(url){
        logo.src = new URL(url, baseUrl()).toString();
        logo.style.display = "block";
        logo.onerror = () => { logo.style.display = "none"; };
      } else {
        logo.style.display = "none";
      }

      // Theme
      applyTheme(state.config?.theme || "novikov_clean");

      // selects
      el("restaurantSelect").value = state.r;
      el("langSelect").value = state.lang;
    }

    function renderSectionNav(){
      const nav = el("sectionNav");
      nav.innerHTML = "";

      const mk = (key, label) => {
        const b = document.createElement("button");
        b.className = "pill" + (state.activeSection === key ? " active" : "");
        b.textContent = label;
        b.onclick = () => {
          state.activeSection = key;
          filterAndRender();
        };
        return b;
      };

      nav.appendChild(mk("all", "All"));

      for(const s of state.sectionsOrdered){
        nav.appendChild(mk(s, s));
      }
    }

    function formatPrice(v){
      const n = Number(v);
      if(!isFinite(n)) return v || "";
      return String(n);
    }

    function safeImg(url){
      if(!url) return "";
      return url;
    }

    function renderGrid(){
      const grid = el("grid");
      grid.innerHTML = "";

      const list = state.filtered;

      for(const w of list){
        const card = document.createElement("div");
        card.className = "card";

        // bottle image
        const bottle = document.createElement("div");
        bottle.className = "bottle";
        const imgUrl = safeImg(w.bottle_img || w.primary_image_url || "");
        if(imgUrl){
          const img = document.createElement("img");
          img.src = imgUrl;
          img.alt = `${w.producer || ""} ${w.name || ""}`.trim();
          img.onerror = () => { img.remove(); };
          bottle.appendChild(img);
        }
        card.appendChild(bottle);

        // meta
        const meta = document.createElement("div");
        meta.className = "meta";

        const line1 = document.createElement("div");
        line1.className = "line1";

        const nameBlock = document.createElement("div");
        nameBlock.className = "nameBlock";
        const title = document.createElement("strong");
        title.textContent = [w.producer, w.name].filter(Boolean).join(" — ") || w.id || "Wine";
        const sub = document.createElement("span");
        const parts = [];
        if(w.vintage) parts.push(w.vintage);
        if(w.country) parts.push(w.country);
        if(w.region) parts.push(w.region);
        if(w.grape) parts.push(w.grape);
        sub.textContent = parts.join(" • ");
        nameBlock.appendChild(title);
        nameBlock.appendChild(sub);

        const prices = document.createElement("div");
        prices.className = "prices";
        const btg = (w.btg_price || "").trim();
        const btl = (w.bottle_price || "").trim();
        // currency column removed in exports; currency comes from config/restaurants
        const cur = (state.config?.currency || "").trim();
        const big = document.createElement("div");
        big.className = "big";
        big.textContent = btl ? `${formatPrice(btl)}${cur ? " " + cur : ""}` : "";
        const small = document.createElement("div");
        small.textContent = btg ? `${formatPrice(btg)}${cur ? " " + cur : ""} / glass` : "";
        prices.appendChild(big);
        prices.appendChild(small);

        line1.appendChild(nameBlock);
        line1.appendChild(prices);
        meta.appendChild(line1);

        // tags
        const tags = document.createElement("div");
        tags.className = "tags";

        if(w.section) {
          const t = document.createElement("span");
          t.className = "tag";
          t.textContent = w.section;
          tags.appendChild(t);
        }
        if(w.style){
          const t = document.createElement("span");
          t.className = "tag";
          t.textContent = w.style;
          tags.appendChild(t);
        }

        meta.appendChild(tags);

        // story
        if(w.story){
          const d = document.createElement("div");
          d.className = "desc";
          d.textContent = w.story;
          meta.appendChild(d);
        }

        // notes
        const foot = document.createElement("div");
        foot.className = "foot";
        const left = document.createElement("div");
        left.className = "muted";
        left.textContent = w.notes ? `Notes: ${w.notes}` : "";
        const right = document.createElement("div");
        right.className = "muted";
        const avail = (w.is_available || "").toLowerCase();
        right.textContent = avail === "no" ? "Not available" : "";
        foot.appendChild(left);
        foot.appendChild(right);
        meta.appendChild(foot);

        card.appendChild(meta);
        grid.appendChild(card);
      }
    }

    function filterAndRender(){
      const query = (el("searchInput").value || "").trim().toLowerCase();

      let list = state.wines;

      if(state.activeSection !== "all"){
        list = list.filter(w => (w.section || "").trim() === state.activeSection);
      }

      if(query){
        list = list.filter(w => {
          const hay = [
            w.id, w.section, w.producer, w.name, w.vintage, w.country, w.region, w.grape, w.style, w.story, w.notes
          ].join(" ").toLowerCase();
          return hay.includes(query);
        });
      }

      // filter visible + available if present
      list = list.filter(w => {
        const v = (w.visible || "").toLowerCase();
        const a = (w.is_available || "").toLowerCase();
        const okVisible = !v || v === "yes";
        const okAvail = !a || a === "yes";
        return okVisible && okAvail;
      });

      // sort by section then by order numeric (fallback)
      list.sort((a,b) => {
        const sa = (a.section || "").toLowerCase();
        const sb = (b.section || "").toLowerCase();
        if(sa < sb) return -1;
        if(sa > sb) return 1;
        const oa = Number(a.order); const ob = Number(b.order);
        if(isFinite(oa) && isFinite(ob)) return oa - ob;
        return (a.id||"").localeCompare(b.id||"");
      });

      state.filtered = list;
      renderSectionNav();
      renderGrid();
    }

    // -----------------------------
    // Main flow
    // -----------------------------
    async function boot(){
      hideStatus();

      // URL params
      state.r = getParam("r") || "novikov_bh";
      state.lang = getParam("lang") || "en";

      try{
        // 1) config
        state.config = await loadConfig(state.r);

        // set default if lang not enabled
        const enabled = state.config.enabledLanguages || ["en"];
        if(!enabled.includes(state.lang)){
          state.lang = state.config.defaultLanguage || enabled[0] || "en";
          setParam("lang", state.lang);
        }

        // 2) theme + header
        renderHeader();

        // 3) CSV
        const csvUrl = state.config.csvUrl?.[state.lang];
        if(!csvUrl) throw new Error(`csvUrl for lang '${state.lang}' not found in config`);

        const wines = await loadCSV(csvUrl);
        state.wines = wines;

        // 4) sections order
        state.sectionsOrdered = Array.isArray(state.config.sectionsOrder) && state.config.sectionsOrder.length
          ? state.config.sectionsOrder
          : computeSectionsFromData(wines);

        state.activeSection = "all";
        filterAndRender();
      }catch(err){
        console.error(err);
        showStatus(
          "❌ Error loading Wine Gallery\\n\\n" +
          String(err && err.message ? err.message : err) +
          "\\n\\n" +
          "Check:\\n" +
          "• configs/{r}.json exists\\n" +
          "• config.csvUrl[lang] works\\n" +
          "• GitHub Pages base path (/winegallery/)\\n"
        );
      }
    }

    // -----------------------------
    // UI handlers (no reload needed)
    // -----------------------------
    el("btnReload").addEventListener("click", () => boot());

    el("searchInput").addEventListener("input", () => filterAndRender());

    el("restaurantSelect").addEventListener("change", async (e) => {
      const r = e.target.value;
      state.r = r;
      setParam("r", r);
      // keep lang param; boot will fix if not enabled
      await boot();
    });

    el("langSelect").addEventListener("change", async (e) => {
      const lang = e.target.value;
      state.lang = lang;
      setParam("lang", lang);
      // IMPORTANT: no full page reload, just re-boot (re-fetch CSV)
      await boot();
    });

    // Start
    boot();
  </script>
</body>
</html>
